# -*- coding: utf-8 -*-

import cv2
import numpy as np

from threading import local


data = local()


def imgdata():
    if 'img' in dir(data):
        return data.img
    else:
        data.img = np.zeros([800, 800, 4], dtype=np.uint8)
        return data.img


COLORMAP = np.array([
    [135,   7,  12, 255],
    [136,   7,  16, 255],
    [137,   6,  19, 255],
    [138,   6,  22, 255],
    [140,   6,  24, 255],
    [141,   6,  27, 255],
    [142,   6,  29, 255],
    [143,   5,  31, 255],
    [144,   5,  33, 255],
    [145,   5,  35, 255],
    [146,   5,  38, 255],
    [146,   5,  40, 255],
    [147,   5,  42, 255],
    [148,   5,  43, 255],
    [149,   4,  45, 255],
    [150,   4,  47, 255],
    [151,   4,  49, 255],
    [151,   4,  51, 255],
    [152,   4,  53, 255],
    [153,   4,  54, 255],
    [154,   4,  56, 255],
    [154,   4,  58, 255],
    [155,   3,  60, 255],
    [156,   3,  61, 255],
    [156,   3,  63, 255],
    [157,   3,  65, 255],
    [158,   3,  66, 255],
    [158,   3,  68, 255],
    [159,   3,  70, 255],
    [160,   2,  71, 255],
    [160,   2,  73, 255],
    [161,   2,  75, 255],
    [161,   2,  76, 255],
    [162,   2,  78, 255],
    [162,   2,  80, 255],
    [163,   1,  81, 255],
    [163,   1,  83, 255],
    [164,   1,  84, 255],
    [164,   1,  86, 255],
    [165,   1,  88, 255],
    [165,   1,  89, 255],
    [165,   0,  91, 255],
    [166,   0,  92, 255],
    [166,   0,  94, 255],
    [166,   0,  95, 255],
    [167,   0,  97, 255],
    [167,   0,  99, 255],
    [167,   0, 100, 255],
    [167,   0, 102, 255],
    [168,   0, 103, 255],
    [168,   0, 105, 255],
    [168,   0, 106, 255],
    [168,   0, 108, 255],
    [168,   0, 110, 255],
    [168,   0, 111, 255],
    [168,   0, 113, 255],
    [169,   0, 114, 255],
    [169,   0, 116, 255],
    [169,   0, 117, 255],
    [168,   1, 119, 255],
    [168,   1, 120, 255],
    [168,   1, 122, 255],
    [168,   2, 123, 255],
    [168,   2, 125, 255],
    [168,   3, 126, 255],
    [168,   3, 128, 255],
    [167,   4, 129, 255],
    [167,   4, 131, 255],
    [167,   5, 132, 255],
    [167,   6, 134, 255],
    [166,   7, 135, 255],
    [166,   7, 136, 255],
    [166,   8, 138, 255],
    [165,   9, 139, 255],
    [165,  11, 141, 255],
    [164,  12, 142, 255],
    [164,  13, 144, 255],
    [163,  14, 145, 255],
    [163,  15, 146, 255],
    [162,  16, 148, 255],
    [161,  17, 149, 255],
    [161,  18, 150, 255],
    [160,  19, 152, 255],
    [160,  20, 153, 255],
    [159,  21, 155, 255],
    [158,  23, 156, 255],
    [157,  24, 157, 255],
    [157,  25, 158, 255],
    [156,  26, 160, 255],
    [155,  27, 161, 255],
    [154,  28, 162, 255],
    [154,  29, 164, 255],
    [153,  30, 165, 255],
    [152,  32, 166, 255],
    [151,  33, 167, 255],
    [150,  34, 169, 255],
    [149,  35, 170, 255],
    [149,  36, 171, 255],
    [148,  37, 172, 255],
    [147,  38, 173, 255],
    [146,  40, 175, 255],
    [145,  41, 176, 255],
    [144,  42, 177, 255],
    [143,  43, 178, 255],
    [142,  44, 179, 255],
    [141,  45, 180, 255],
    [140,  46, 181, 255],
    [139,  47, 183, 255],
    [138,  49, 184, 255],
    [137,  50, 185, 255],
    [137,  51, 186, 255],
    [136,  52, 187, 255],
    [135,  53, 188, 255],
    [134,  54, 189, 255],
    [133,  55, 190, 255],
    [132,  57, 191, 255],
    [131,  58, 192, 255],
    [130,  59, 193, 255],
    [129,  60, 194, 255],
    [128,  61, 195, 255],
    [127,  62, 196, 255],
    [126,  63, 197, 255],
    [125,  64, 198, 255],
    [124,  66, 199, 255],
    [123,  67, 200, 255],
    [122,  68, 201, 255],
    [122,  69, 202, 255],
    [121,  70, 203, 255],
    [120,  71, 204, 255],
    [119,  72, 205, 255],
    [118,  73, 206, 255],
    [117,  75, 207, 255],
    [116,  76, 208, 255],
    [115,  77, 208, 255],
    [114,  78, 209, 255],
    [113,  79, 210, 255],
    [112,  80, 211, 255],
    [112,  81, 212, 255],
    [111,  83, 213, 255],
    [110,  84, 214, 255],
    [109,  85, 215, 255],
    [108,  86, 215, 255],
    [107,  87, 216, 255],
    [106,  88, 217, 255],
    [105,  89, 218, 255],
    [105,  91, 219, 255],
    [104,  92, 220, 255],
    [103,  93, 220, 255],
    [102,  94, 221, 255],
    [101,  95, 222, 255],
    [100,  96, 223, 255],
    [ 99,  98, 224, 255],
    [ 98,  99, 224, 255],
    [ 98, 100, 225, 255],
    [ 97, 101, 226, 255],
    [ 96, 102, 227, 255],
    [ 95, 104, 227, 255],
    [ 94, 105, 228, 255],
    [ 93, 106, 229, 255],
    [ 92, 107, 230, 255],
    [ 92, 108, 230, 255],
    [ 91, 110, 231, 255],
    [ 90, 111, 232, 255],
    [ 89, 112, 232, 255],
    [ 88, 113, 233, 255],
    [ 87, 114, 234, 255],
    [ 86, 116, 235, 255],
    [ 86, 117, 235, 255],
    [ 85, 118, 236, 255],
    [ 84, 119, 237, 255],
    [ 83, 121, 237, 255],
    [ 82, 122, 238, 255],
    [ 81, 123, 238, 255],
    [ 80, 124, 239, 255],
    [ 80, 126, 240, 255],
    [ 79, 127, 240, 255],
    [ 78, 128, 241, 255],
    [ 77, 129, 241, 255],
    [ 76, 131, 242, 255],
    [ 75, 132, 242, 255],
    [ 74, 133, 243, 255],
    [ 73, 135, 244, 255],
    [ 73, 136, 244, 255],
    [ 72, 137, 245, 255],
    [ 71, 139, 245, 255],
    [ 70, 140, 246, 255],
    [ 69, 141, 246, 255],
    [ 68, 143, 247, 255],
    [ 67, 144, 247, 255],
    [ 67, 145, 247, 255],
    [ 66, 147, 248, 255],
    [ 65, 148, 248, 255],
    [ 64, 149, 249, 255],
    [ 63, 151, 249, 255],
    [ 62, 152, 249, 255],
    [ 61, 154, 250, 255],
    [ 60, 155, 250, 255],
    [ 60, 156, 251, 255],
    [ 59, 158, 251, 255],
    [ 58, 159, 251, 255],
    [ 57, 161, 251, 255],
    [ 56, 162, 252, 255],
    [ 55, 164, 252, 255],
    [ 54, 165, 252, 255],
    [ 54, 166, 252, 255],
    [ 53, 168, 253, 255],
    [ 52, 169, 253, 255],
    [ 51, 171, 253, 255],
    [ 50, 172, 253, 255],
    [ 49, 174, 253, 255],
    [ 49, 175, 254, 255],
    [ 48, 177, 254, 255],
    [ 47, 178, 254, 255],
    [ 46, 180, 254, 255],
    [ 46, 181, 254, 255],
    [ 45, 183, 254, 255],
    [ 44, 185, 254, 255],
    [ 43, 186, 254, 255],
    [ 43, 188, 254, 255],
    [ 42, 189, 254, 255],
    [ 41, 191, 254, 255],
    [ 41, 192, 254, 255],
    [ 40, 194, 254, 255],
    [ 40, 195, 254, 255],
    [ 39, 197, 254, 255],
    [ 39, 199, 254, 255],
    [ 38, 200, 253, 255],
    [ 38, 202, 253, 255],
    [ 37, 203, 253, 255],
    [ 37, 205, 253, 255],
    [ 37, 207, 253, 255],
    [ 36, 208, 252, 255],
    [ 36, 210, 252, 255],
    [ 36, 212, 252, 255],
    [ 36, 213, 251, 255],
    [ 36, 215, 251, 255],
    [ 36, 217, 251, 255],
    [ 36, 218, 250, 255],
    [ 36, 220, 250, 255],
    [ 36, 222, 249, 255],
    [ 36, 223, 249, 255],
    [ 37, 225, 248, 255],
    [ 37, 227, 248, 255],
    [ 37, 229, 247, 255],
    [ 37, 230, 247, 255],
    [ 38, 232, 246, 255],
    [ 38, 234, 246, 255],
    [ 38, 235, 245, 255],
    [ 39, 237, 244, 255],
    [ 39, 239, 244, 255],
    [ 39, 241, 243, 255],
    [ 38, 242, 242, 255],
    [ 38, 244, 242, 255],
    [ 37, 246, 241, 255],
    [ 36, 247, 241, 255],
    [ 33, 249, 240, 255],
], dtype=np.uint8)


def colorize(data, out):
    data = data.reshape(800, 800)
    fliped = (data[:, ::-1] * 2560).astype(np.uint8)
    return np.take(COLORMAP, fliped, axis=0, out=out)


def imsave(fileobj, data):
    is_success, img = cv2.imencode(".png", data)
    buffer = img.tobytes()
    fileobj.write(buffer)


def plot(fileobj, data):
    imsave(fileobj, colorize(data, imgdata()))
